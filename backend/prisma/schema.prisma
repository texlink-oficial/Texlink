// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN
  BRAND
  SUPPLIER
}

enum CompanyType {
  BRAND
  SUPPLIER
}

enum CompanyStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum CompanyUserRole {
  OWNER
  MANAGER
  MEMBER
}

// Roles pré-definidos para membros da empresa
enum CompanyRole {
  ADMIN // Todas as permissões + gestão de equipe
  OPERATIONS_MANAGER // Pedidos, fornecedores, mensagens, relatórios
  FINANCIAL_MANAGER // Financeiro, relatórios
  SALES // Criar pedidos, ver fornecedores, mensagens
  PRODUCTION_MANAGER // (Facção) Pedidos, capacidade, mensagens
  VIEWER // Apenas visualização
}

// Permissões granulares
enum Permission {
  // Pedidos
  ORDERS_VIEW
  ORDERS_CREATE
  ORDERS_EDIT
  ORDERS_DELETE
  ORDERS_ACCEPT_REJECT // Aceitar/rejeitar (facção)
  ORDERS_UPDATE_STATUS

  // Fornecedores/Parceiros
  SUPPLIERS_VIEW
  SUPPLIERS_ADD
  SUPPLIERS_REMOVE
  SUPPLIERS_RATE

  // Financeiro
  FINANCIAL_VIEW
  FINANCIAL_MANAGE
  FINANCIAL_EXPORT

  // Mensagens
  MESSAGES_VIEW
  MESSAGES_SEND

  // Relatórios
  REPORTS_VIEW
  REPORTS_EXPORT

  // Gestão de Equipe
  TEAM_VIEW
  TEAM_INVITE
  TEAM_MANAGE
  TEAM_MANAGE_PERMISSIONS

  // Configurações
  SETTINGS_VIEW
  SETTINGS_EDIT

  // Capacidade (Facção)
  CAPACITY_VIEW
  CAPACITY_MANAGE
}

// Status de convite
enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum DocumentType {
  ALVARA
  CERTIFICACAO
  FOTO_OPERACAO
  FOTO_PRODUTO
  OUTRO
}

enum OrderStatus {
  LANCADO_PELA_MARCA
  EM_NEGOCIACAO // Em negociação entre marca e facção
  ACEITO_PELA_FACCAO
  EM_PREPARACAO_SAIDA_MARCA
  EM_TRANSITO_PARA_FACCAO
  EM_PREPARACAO_ENTRADA_FACCAO
  FILA_DE_PRODUCAO // Fila de produção (aguardando início)
  EM_PRODUCAO
  PRONTO
  EM_TRANSITO_PARA_MARCA
  EM_REVISAO // Em revisão de qualidade
  PARCIALMENTE_APROVADO // Parte aprovada, parte com problemas
  REPROVADO // Totalmente reprovado
  AGUARDANDO_RETRABALHO // Aguardando pedido filho ser aceito
  EM_PROCESSO_PAGAMENTO // Em processo de pagamento (após aprovação total)
  FINALIZADO
  CANCELADO // Pedido cancelado no meio do processo
  RECUSADO_PELA_FACCAO
  DISPONIVEL_PARA_OUTRAS
}

// Origem do pedido (original ou retrabalho)
enum OrderOrigin {
  ORIGINAL // Pedido original
  REWORK // Retrabalho de pedido reprovado
}

// Tipo de revisão
enum ReviewType {
  QUALITY_CHECK // Verificação de qualidade durante produção
  FINAL_REVIEW // Revisão final antes de finalizar
}

// Resultado da revisão
enum ReviewResult {
  APPROVED // 100% aprovado
  PARTIAL // Parcialmente aprovado
  REJECTED // 100% reprovado
}

enum OrderAssignmentType {
  DIRECT
  BIDDING
  HYBRID
}

enum OrderTargetStatus {
  PENDING
  INTERESTED
  ACCEPTED
  REJECTED
}

enum AttachmentType {
  TECH_SHEET
  VIDEO
  IMAGE
  DOC
  OTHER
}

enum PaymentStatus {
  PENDENTE
  PARCIAL
  PAGO
  ATRASADO
}

enum MessageType {
  TEXT
  PROPOSAL
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// ==================== CREDENTIAL SYSTEM ENUMS ====================

enum SupplierCredentialStatus {
  DRAFT // Rascunho inicial
  PENDING_VALIDATION // Aguardando validação de CNPJ
  VALIDATING // Validação em andamento
  VALIDATION_FAILED // Validação falhou
  PENDING_COMPLIANCE // Aguardando análise de compliance
  COMPLIANCE_APPROVED // Compliance aprovado
  COMPLIANCE_REJECTED // Compliance rejeitado
  INVITATION_PENDING // Convite pronto para enviar
  INVITATION_SENT // Convite enviado
  INVITATION_OPENED // Convite aberto
  INVITATION_EXPIRED // Convite expirado
  ONBOARDING_STARTED // Onboarding iniciado
  ONBOARDING_IN_PROGRESS // Onboarding em progresso
  CONTRACT_PENDING // Aguardando assinatura de contrato
  CONTRACT_SIGNED // Contrato assinado
  ACTIVE // Facção ativa na plataforma
  SUSPENDED // Temporariamente suspensa
  BLOCKED // Bloqueada
}

enum ValidationSource {
  RECEITA_FEDERAL
  SINTEGRA
  SERASA
  SPC
  MANUAL
  OTHER
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ManualReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum InvitationType {
  EMAIL
  WHATSAPP
  SMS
  LINK
}

enum ContractStatus {
  DRAFT
  PENDING_BRAND_SIGNATURE
  PENDING_SUPPLIER_SIGNATURE
  SIGNED
  EXPIRED
  CANCELLED
}

enum ContractType {
  SERVICE_AGREEMENT // Contrato de Prestacao de Servicos
  NDA // Termo de Confidencialidade
  CODE_OF_CONDUCT // Codigo de Conduta
  AMENDMENT // Aditivo contratual
}

enum ContractRevisionStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum RelationshipStatus {
  PENDING // Aguardando ativação
  CONTRACT_PENDING // Aguardando assinatura de contrato
  ACTIVE // Ativo
  SUSPENDED // Suspenso temporariamente
  TERMINATED // Encerrado permanentemente
}

// ==================== SUPPORT TICKETS ENUMS ====================

enum SupportTicketStatus {
  ABERTO
  EM_ANDAMENTO
  AGUARDANDO_RESPOSTA
  RESOLVIDO
  FECHADO
}

enum SupportTicketPriority {
  BAIXA
  MEDIA
  ALTA
  URGENTE
}

enum SupportTicketCategory {
  PEDIDOS
  PAGAMENTOS
  ACESSO
  TECNICO
  FORNECEDORES
  RELATORIOS
  SUGESTAO
  OUTROS
}

// ==================== SETTINGS ENUMS ====================

enum AccountType {
  CORRENTE
  POUPANCA
}

enum PixKeyType {
  CPF
  CNPJ
  EMAIL
  TELEFONE
  ALEATORIA
}

enum SuggestionCategory {
  FUNCIONALIDADE
  USABILIDADE
  BUG
  PERFORMANCE
  OUTRO
}

enum SuggestionStatus {
  ENVIADO
  EM_ANALISE
  IMPLEMENTADO
  REJEITADO
}

// ==================== BRAND DOCUMENT ENUMS ====================

enum BrandDocumentType {
  CODE_OF_CONDUCT
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  OTHER
}

enum BrandDocumentStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

// ==================== PARTNERSHIP REQUEST ENUMS ====================

enum PartnershipRequestStatus {
  PENDING // Aguardando decisão do fornecedor
  ACCEPTED // Aceito, relacionamento criado
  REJECTED // Recusado pelo fornecedor
  CANCELLED // Cancelado pela marca
  EXPIRED // Expirado (30 dias sem resposta)
}

// ==================== NOTIFICATION SYSTEM ENUMS ====================

enum NotificationType {
  ORDER_CREATED
  ORDER_ACCEPTED
  ORDER_REJECTED
  ORDER_STATUS_CHANGED
  ORDER_PROPOSAL_RECEIVED
  ORDER_PROPOSAL_RESPONDED
  ORDER_DEADLINE_APPROACHING
  ORDER_FINALIZED
  MESSAGE_RECEIVED
  MESSAGE_UNREAD_REMINDER
  CREDENTIAL_INVITE_SENT
  CREDENTIAL_STATUS_CHANGED
  CREDENTIAL_COMPLETED
  DOCUMENT_EXPIRING
  DOCUMENT_EXPIRED
  PAYMENT_REGISTERED
  PAYMENT_RECEIVED
  PAYMENT_OVERDUE
  TICKET_CREATED
  TICKET_MESSAGE_ADDED
  TICKET_STATUS_CHANGED
  RELATIONSHIP_REQUESTED
  RELATIONSHIP_STATUS_CHANGED
  PARTNERSHIP_REQUEST_RECEIVED
  PARTNERSHIP_REQUEST_ACCEPTED
  PARTNERSHIP_REQUEST_REJECTED
  PARTNERSHIP_REQUEST_CANCELLED
  RATING_RECEIVED
  SYSTEM_ANNOUNCEMENT
  SUPPLIER_DOCUMENT_EXPIRING_FOR_BRAND
  SUPPLIER_DOCUMENT_UPDATED
  DOCUMENT_SHARING_CONSENT_REVOKED
  CODE_OF_CONDUCT_UPLOADED
  CODE_OF_CONDUCT_UPDATED
  CODE_OF_CONDUCT_ACCEPTED
  CODE_OF_CONDUCT_REMINDER
  CONTRACT_CREATED
  CONTRACT_SENT_FOR_SIGNATURE
  CONTRACT_REVISION_REQUESTED
  CONTRACT_REVISION_RESPONDED
  CONTRACT_SIGNED
  CONTRACT_FULLY_SIGNED
  CONTRACT_EXPIRING
  CONTRACT_EXPIRED
  CONTRACT_CANCELLED
  SUPPLIER_STATUS_CHANGED
  SUPPLIER_INTEREST_EXPRESSED
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationDeliveryStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  SKIPPED
}

// ==================== MODELS ====================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  role         UserRole
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  companyUsers       CompanyUser[]
  orderStatusChanges OrderStatusHistory[]
  messages           Message[]
  ordersAccepted     Order[]              @relation("AcceptedBy")
  invitationsSent    Invitation[]         @relation("InvitationsSent")
  reviewsPerformed   OrderReview[]        @relation("ReviewedBy")

  // Credential system relations
  credentialsCreated      SupplierCredential[]      @relation("CredentialCreatedBy")
  credentialStatusChanges CredentialStatusHistory[] @relation("CredentialStatusChangedBy")
  complianceReviews       ComplianceAnalysis[]      @relation("ComplianceReviewedBy")
  onboardings             SupplierOnboarding[]
  documentsValidated      OnboardingDocument[]      @relation("DocumentValidatedBy")
  contractsBrandSigned    SupplierContract[]        @relation("ContractBrandSignedBy")
  contractsSupplierSigned SupplierContract[]        @relation("ContractSupplierSignedBy")
  contractsCreated        SupplierContract[]        @relation("ContractsCreated")
  revisionsRequested      ContractRevision[]        @relation("RevisionsRequested")
  revisionsResponded      ContractRevision[]        @relation("RevisionsResponded")

  // Relationship system relations (N:M)
  relationshipsInitiated     SupplierBrandRelationship[] @relation("RelationshipsInitiated")
  relationshipStatusChanges  RelationshipStatusHistory[] @relation("RelationshipStatusChanged")
  brandSpecificDocsValidated BrandSpecificDocument[]     @relation("BrandDocsValidated")

  // Supplier documents uploaded
  documentsUploaded SupplierDocument[] @relation("DocumentsUploaded")

  // Support tickets relations
  ticketsCreated      SupportTicket[]              @relation("TicketsCreated")
  ticketsAssigned     SupportTicket[]              @relation("TicketsAssigned")
  ticketMessagesSent  SupportTicketMessage[]       @relation("TicketMessagesSent")
  ticketStatusChanges SupportTicketStatusHistory[] @relation("TicketStatusChanges")

  // Settings relations
  suggestions       Suggestion[]
  passwordChangedAt DateTime?

  // Notification relations
  notificationsReceived Notification[] @relation("NotificationsReceived")

  // Partnership request relations
  partnershipRequestsSent      PartnershipRequest[] @relation("PartnershipRequestsSent")
  partnershipRequestsResponded PartnershipRequest[] @relation("PartnershipRequestsResponded")

  // Brand document relations
  brandDocumentsUploaded BrandDocument[]           @relation("BrandDocumentsUploaded")
  acceptedBrandDocuments BrandDocumentAcceptance[] @relation("AcceptedBrandDocuments")

  // Admin actions
  adminActionsPerformed AdminAction[] @relation("AdminActionsPerformed")

  // Performance indexes
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

model Company {
  id        String        @id @default(uuid())
  legalName String
  tradeName String?
  document  String        @unique // CNPJ or CPF
  type      CompanyType
  city      String
  state     String
  phone     String?
  email     String?
  logoUrl   String?
  avgRating Decimal       @default(0) @db.Decimal(2, 1)
  status           CompanyStatus @default(PENDING)
  statusReason     String?       @db.Text
  statusChangedAt  DateTime?
  statusChangedById String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Address fields
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  zipCode      String?

  // Relations
  companyUsers     CompanyUser[]
  supplierProfile  SupplierProfile?
  brandProfile     BrandProfile?
  documents        Document[]
  ordersAsBrand    Order[]               @relation("BrandOrders")
  ordersAsSupplier Order[]               @relation("SupplierOrders")
  targetedOrders   OrderTargetSupplier[]
  ratingsGiven     Rating[]              @relation("RatingsGiven")
  ratingsReceived  Rating[]              @relation("RatingsReceived")
  invitations      Invitation[]

  // Favorites & Templates (for BRAND)
  productTemplates    ProductTemplate[]
  favoriteSuppliers   FavoriteSupplier[]   @relation("BrandFavorites")
  favoritedBy         FavoriteSupplier[]   @relation("FavoritedBy")
  paymentTermsPresets PaymentTermsPreset[]

  // Credential system relations (for BRAND)
  credentialsInitiated SupplierCredential[] @relation("CredentialBrand")
  credentialsReceived  SupplierCredential[] @relation("CredentialSupplier")
  credentialSettings   CredentialSettings?
  invitationTemplates  InvitationTemplate[]
  contractTemplates    ContractTemplate[]

  // Relationship system (N:M)
  supplierRelationships SupplierBrandRelationship[] @relation("SupplierRelationships") // Como fornecedor
  brandSuppliers        SupplierBrandRelationship[] @relation("BrandSuppliers") // Como marca
  onboarding            SupplierOnboarding?         @relation("SupplierOnboarding") // Como fornecedor
  contractsAsSupplier   SupplierContract[]          @relation("SupplierContracts")
  contractsAsBrand      SupplierContract[]          @relation("BrandContracts")

  // Supplier documents (compliance/fiscal)
  supplierDocuments SupplierDocument[] @relation("SupplierDocuments")

  // Support tickets
  supportTickets SupportTicket[] @relation("CompanyTickets")

  // Partnership requests
  partnershipRequestsAsBrand    PartnershipRequest[] @relation("BrandPartnershipRequests")
  partnershipRequestsAsSupplier PartnershipRequest[] @relation("SupplierPartnershipRequests")

  // Brand documents (compliance/conduct)
  brandDocuments BrandDocument[] @relation("BrandDocuments")

  // Admin actions
  adminActions AdminAction[] @relation("CompanyAdminActions")

  // Settings
  bankAccount          BankAccount?
  notificationSettings NotificationSettings?
  suggestions          Suggestion[]

  @@map("companies")
}

model CompanyUser {
  id             String          @id @default(uuid())
  userId         String
  companyId      String
  role           CompanyUserRole @default(MEMBER) // Mantido para compatibilidade
  companyRole    CompanyRole     @default(VIEWER) // Role pré-definido
  isCompanyAdmin Boolean         @default(false) // Flag de admin
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  user        User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  permissions CompanyUserPermission[] // Overrides individuais

  @@unique([userId, companyId])
  @@map("company_users")
}

// Override de permissão individual por usuário
model CompanyUserPermission {
  id            String     @id @default(uuid())
  companyUserId String
  permission    Permission
  granted       Boolean    @default(true) // true = conceder, false = negar
  createdAt     DateTime   @default(now())

  companyUser CompanyUser @relation(fields: [companyUserId], references: [id], onDelete: Cascade)

  @@unique([companyUserId, permission])
  @@map("company_user_permissions")
}

// Sistema de convites
model Invitation {
  id          String           @id @default(uuid())
  companyId   String
  email       String
  companyRole CompanyRole      @default(VIEWER)
  invitedById String
  token       String           @unique @default(uuid())
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  createdAt   DateTime         @default(now())

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invitedBy User    @relation("InvitationsSent", fields: [invitedById], references: [id])

  @@unique([companyId, email, status]) // Um convite pendente por email/empresa
  @@map("invitations")
}

model SupplierProfile {
  id                 String  @id @default(uuid())
  companyId          String  @unique
  onboardingPhase    Int     @default(1) // 1, 2, or 3
  onboardingComplete Boolean @default(false)

  // Phase 2: Business Qualification
  businessQualification Json? // { interesse, faturamentoDesejado, maturidadeGestao, qtdColaboradores }

  // Phase 3: Production Capacity
  productionCapacity Json? // { tiposProduto, subcategorias, especialidades }
  productTypes       String[] // e.g., ["Infantil", "Adulto", "Fitness"]
  specialties        String[] // e.g., ["Jeans", "Malha", "Tricô"]

  monthlyCapacity  Int? // peças/mês (legacy/cached)
  currentOccupancy Int      @default(0) // % ocupação atual
  activeWorkers    Int? // número de colaboradores ativos na produção
  hoursPerDay      Decimal? @db.Decimal(4, 2) // horas de trabalho por dia
  desiredRevenue   Decimal? @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("supplier_profiles")
}

model BrandProfile {
  id                 String  @id @default(uuid())
  companyId          String  @unique
  onboardingPhase    Int     @default(1) // 1, 2, or 3
  onboardingComplete Boolean @default(false)

  // Phase 2: Business Qualification
  businessQualification Json? // { objetivo, volumeMensal, maturidadeGestao, qtdColaboradores, tempoMercado }

  // Phase 3: Product Needs
  productNeeds    Json?    // { segmentos, necessidades }
  productTypes    String[] // e.g., ["Infantil", "Adulto Feminino", "Fitness"]
  specialties     String[] // e.g., ["Jeans", "Malha", "Tricô"]
  monthlyVolume   Int?     // peças/mês desejado
  desiredRevenue  Decimal? @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("brand_profiles")
}

model Document {
  id        String       @id @default(uuid())
  companyId String
  type      DocumentType
  name      String
  url       String
  mimeType  String
  size      Int // bytes
  createdAt DateTime     @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Order {
  id             String  @id @default(uuid())
  displayId      String  @unique // TX-YYYYMMDD-XXXX ou TX-YYYYMMDD-XXXX-R1
  brandId        String
  supplierId     String? // null until accepted in BIDDING mode
  relationshipId String? // Vinculado ao relacionamento marca-facção (N:M)

  status         OrderStatus         @default(LANCADO_PELA_MARCA)
  assignmentType OrderAssignmentType @default(DIRECT)

  // Hierarquia de pedidos (pai/filho para retrabalho)
  parentOrderId  String?
  parentOrder    Order?      @relation("OrderHierarchy", fields: [parentOrderId], references: [id])
  childOrders    Order[]     @relation("OrderHierarchy")
  revisionNumber Int         @default(0) // 0 = original, 1+ = retrabalho
  origin         OrderOrigin @default(ORIGINAL)

  // Product info
  productType     String // e.g., "Infantil"
  productCategory String? // e.g., "Camiseta"
  productName     String
  op              String? // Ordem de Produção
  artigo          String? // Código do Artigo
  description     String?

  quantity     Int
  pricePerUnit Decimal  @db.Decimal(10, 2)
  totalValue   Decimal  @db.Decimal(12, 2)
  platformFee  Decimal? @db.Decimal(10, 2) // Taxa de serviço
  netValue     Decimal? @db.Decimal(12, 2) // Valor líquido para a facção

  deliveryDeadline  DateTime
  paymentTerms      String? // e.g., "50% adiantado, 50% na entrega"
  materialsProvided Boolean  @default(false)

  techSheetUrl          String?
  observations          String?
  protectTechnicalSheet Boolean @default(false) // Proteger ficha técnica até aceite
  rejectionReason       String?

  acceptedAt   DateTime?
  acceptedById String?

  // Production planning (capacity system)
  avgTimePerPiece        Decimal?  @db.Decimal(8, 2) // minutos por peça (definido pela facção)
  suggestedTimePerPiece  Decimal?  @db.Decimal(8, 2) // sugestão do sistema
  totalProductionMinutes Int? // quantity * avgTimePerPiece
  plannedStartDate       DateTime?
  plannedEndDate         DateTime?
  actualStartDate        DateTime?
  actualEndDate          DateTime?

  // Métricas de revisão agregadas
  totalReviewCount   Int @default(0)
  approvalCount      Int @default(0)
  rejectionCount     Int @default(0)
  secondQualityCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  brand        Company                    @relation("BrandOrders", fields: [brandId], references: [id])
  supplier     Company?                   @relation("SupplierOrders", fields: [supplierId], references: [id])
  relationship SupplierBrandRelationship? @relation("RelationshipOrders", fields: [relationshipId], references: [id])
  acceptedBy   User?                      @relation("AcceptedBy", fields: [acceptedById], references: [id])

  statusHistory      OrderStatusHistory[]
  attachments        OrderAttachment[]
  targetSuppliers    OrderTargetSupplier[]
  messages           Message[]
  payments           Payment[]
  ratings            Rating[]
  reviews            OrderReview[]
  secondQualityItems SecondQualityItem[]

  @@index([relationshipId])
  @@map("orders")
}

model OrderTargetSupplier {
  id          String            @id @default(uuid())
  orderId     String
  supplierId  String
  status      OrderTargetStatus @default(PENDING)
  message     String?           // Optional message when expressing interest
  respondedAt DateTime?
  createdAt   DateTime          @default(now())

  order    Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  supplier Company @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([orderId, supplierId])
  @@map("order_target_suppliers")
}

model OrderStatusHistory {
  id             String       @id @default(uuid())
  orderId        String
  previousStatus OrderStatus?
  newStatus      OrderStatus
  changedById    String?
  notes          String?
  createdAt      DateTime     @default(now())

  order     Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  changedBy User? @relation(fields: [changedById], references: [id])

  @@map("order_status_history")
}

model OrderAttachment {
  id            String         @id @default(uuid())
  orderId       String
  type          AttachmentType
  name          String
  url           String
  mimeType      String
  size          Int // bytes
  downloadCount Int            @default(0)
  createdAt     DateTime       @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_attachments")
}

model Payment {
  id        String        @id @default(uuid())
  orderId   String
  amount    Decimal       @db.Decimal(12, 2)
  dueDate   DateTime
  paidDate  DateTime?
  status    PaymentStatus @default(PENDENTE)
  method    String? // e.g., "PIX", "Boleto", "Transferência"
  proofUrl  String?
  notes     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Rating {
  id            String   @id @default(uuid())
  orderId       String
  fromCompanyId String
  toCompanyId   String
  score         Int // 1 to 5
  comment       String?
  createdAt     DateTime @default(now())

  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fromCompany Company @relation("RatingsGiven", fields: [fromCompanyId], references: [id])
  toCompany   Company @relation("RatingsReceived", fields: [toCompanyId], references: [id])

  @@unique([orderId, fromCompanyId]) // Each company can rate once per order
  @@map("ratings")
}

model Message {
  id       String      @id @default(uuid())
  orderId  String
  senderId String
  type     MessageType @default(TEXT)
  content  String?

  // For proposals
  proposalData Json? // { originalValues, newValues, status }

  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  order  Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sender User  @relation(fields: [senderId], references: [id])

  // Performance indexes
  @@index([orderId, createdAt(sort: Desc)], name: "idx_messages_order_date")
  @@index([orderId, read, senderId], name: "idx_messages_unread")
  @@index([senderId, createdAt(sort: Desc)], name: "idx_messages_sender")
  @@map("messages")
}

// ==================== FAVORITES & TEMPLATES ====================

// Product template for reuse when creating orders
model ProductTemplate {
  id                String   @id @default(uuid())
  companyId         String
  name              String // Template name (e.g., "Camiseta Básica Padrão")
  productType       String
  productCategory   String?
  productName       String
  description       String?
  materialsProvided Boolean  @default(false)
  defaultPrice      Decimal? @db.Decimal(10, 2)
  observations      String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("product_templates")
}

// Favorite supplier for brands
model FavoriteSupplier {
  id         String   @id @default(uuid())
  companyId  String // Brand
  supplierId String // Supplier (Facção)
  notes      String? // Personal notes
  priority   Int      @default(0) // Preference order
  createdAt  DateTime @default(now())

  company  Company @relation("BrandFavorites", fields: [companyId], references: [id], onDelete: Cascade)
  supplier Company @relation("FavoritedBy", fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([companyId, supplierId])
  @@map("favorite_suppliers")
}

// Payment terms presets
model PaymentTermsPreset {
  id        String   @id @default(uuid())
  companyId String
  name      String // Preset name (e.g., "Parcelado 30/60/90")
  terms     String // Payment terms text
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("payment_terms_presets")
}

// ==================== ORDER REVIEW SYSTEM ====================

// Revisão de qualidade do pedido
model OrderReview {
  id                    String       @id @default(uuid())
  orderId               String
  type                  ReviewType
  result                ReviewResult
  totalQuantity         Int // Quantidade total revisada
  approvedQuantity      Int          @default(0)
  rejectedQuantity      Int          @default(0)
  secondQualityQuantity Int          @default(0)
  notes                 String?
  reviewedAt            DateTime     @default(now())
  reviewedById          String

  // Se gerou pedido filho de retrabalho
  childOrderId String? // ID do pedido filho gerado (se houver)

  order         Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)
  reviewedBy    User                 @relation("ReviewedBy", fields: [reviewedById], references: [id])
  rejectedItems ReviewRejectedItem[]
  createdAt     DateTime             @default(now())

  @@map("order_reviews")
}

// Itens reprovados em uma revisão (detalhes)
model ReviewRejectedItem {
  id                String  @id @default(uuid())
  reviewId          String
  reason            String // Motivo da reprovação
  quantity          Int
  defectDescription String? // Descrição detalhada do defeito
  requiresRework    Boolean @default(true) // Se precisa de retrabalho

  review OrderReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_rejected_items")
}

// Itens de segunda qualidade gerados por revisões
model SecondQualityItem {
  id                 String   @id @default(uuid())
  orderId            String
  reviewId           String? // Referência à revisão que gerou (opcional)
  quantity           Int
  defectType         String // Tipo do defeito (ex: "Costura", "Manchado")
  defectDescription  String?
  originalUnitValue  Decimal  @db.Decimal(10, 2) // Valor original da peça
  discountPercentage Decimal  @default(0) @db.Decimal(5, 2) // % de desconto aplicado
  finalUnitValue     Decimal? @db.Decimal(10, 2) // Valor final com desconto
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("second_quality_items")
}

// ==================== SUPPLIER CREDENTIAL SYSTEM ====================

// Registro principal de credenciamento de facção
model SupplierCredential {
  id          String  @id @default(uuid())
  brandId     String
  supplierId  String? // Null até facção ser criada
  createdById String

  // Dados da facção (informados pela marca)
  cnpj            String
  tradeName       String?
  legalName       String?
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  contactWhatsapp String?

  // Endereço
  addressStreet       String?
  addressNumber       String?
  addressComplement   String?
  addressNeighborhood String?
  addressCity         String?
  addressState        String?
  addressZipCode      String?

  // Controle interno da marca
  internalCode String? // Código interno da marca
  category     String? // Categoria/segmento
  notes        String? // Observações internas
  priority     Int     @default(0) // Ordem de prioridade

  // Status e controle
  status      SupplierCredentialStatus @default(DRAFT)
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  expiresAt   DateTime? // Data de expiração do convite
  completedAt DateTime? // Data de conclusão do credenciamento

  // Relations
  brand     Company  @relation("CredentialBrand", fields: [brandId], references: [id], onDelete: Cascade)
  supplier  Company? @relation("CredentialSupplier", fields: [supplierId], references: [id])
  createdBy User     @relation("CredentialCreatedBy", fields: [createdById], references: [id])

  statusHistory        CredentialStatusHistory[]
  validations          CredentialValidation[]
  compliance           ComplianceAnalysis?
  invitations          CredentialInvitation[]
  onboarding           SupplierOnboarding?       @relation(fields: [supplierOnboardingId], references: [id])
  contract             SupplierContract?
  supplierOnboardingId String?

  @@unique([brandId, cnpj])
  @@index([brandId])
  @@index([cnpj])
  @@index([status])
  @@index([createdAt])
  @@map("supplier_credentials")
}

// Histórico de mudanças de status do credenciamento
model CredentialStatusHistory {
  id            String                    @id @default(uuid())
  credentialId  String
  fromStatus    SupplierCredentialStatus?
  toStatus      SupplierCredentialStatus
  reason        String?
  metadata      Json? // Dados adicionais do evento
  performedById String?
  createdAt     DateTime                  @default(now())

  credential  SupplierCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)
  performedBy User?              @relation("CredentialStatusChangedBy", fields: [performedById], references: [id])

  @@index([credentialId])
  @@map("credential_status_history")
}

// Validações de CNPJ e consultas externas
model CredentialValidation {
  id           String           @id @default(uuid())
  credentialId String
  source       ValidationSource
  type         String? // Tipo específico de validação (ex: "cnpj_status", "credit_check")

  // Resultado
  isValid     Boolean?
  score       Int? // Score de 0-1000
  rawResponse Json? // Resposta bruta da API
  parsedData  Json? // Dados normalizados

  // Dados extraídos da validação
  companyStatus       String? // Situação cadastral
  companyType         String? // Natureza jurídica
  mainActivity        String? // CNAE principal
  secondaryActivities String[] // CNAEs secundários
  foundedAt           DateTime? // Data de abertura
  capitalStock        Decimal?  @db.Decimal(15, 2) // Capital social
  partnerNames        String[] // Nomes dos sócios

  // Controle
  errorMessage String?
  retryCount   Int       @default(0)
  validatedAt  DateTime?
  expiresAt    DateTime? // Quando a validação expira
  createdAt    DateTime  @default(now())

  credential SupplierCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@index([credentialId])
  @@map("credential_validations")
}

// Análise de compliance consolidada
model ComplianceAnalysis {
  id           String @id @default(uuid())
  credentialId String @unique

  // Scores (0-100)
  overallScore Int?
  creditScore  Int?
  taxScore     Int?
  legalScore   Int?

  // Risco
  riskLevel   RiskLevel @default(MEDIUM)
  riskFactors Json? // Array de fatores de risco identificados

  // Flags de verificação
  hasActiveCNPJ          Boolean @default(false)
  hasRegularTaxStatus    Boolean @default(false)
  hasNegativeCredit      Boolean @default(false)
  hasLegalIssues         Boolean @default(false)
  hasRelatedRestrictions Boolean @default(false)

  // Recomendação automática
  recommendation       String? // APPROVE, REJECT, MANUAL_REVIEW
  recommendationReason String?
  requiresManualReview Boolean @default(false)

  // Revisão manual
  manualReviewStatus ManualReviewStatus?
  manualReviewNotes  String?
  reviewedById       String?
  reviewedAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  credential SupplierCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)
  reviewedBy User?              @relation("ComplianceReviewedBy", fields: [reviewedById], references: [id])

  @@map("compliance_analyses")
}

// Convites enviados para a facção
model CredentialInvitation {
  id           String         @id @default(uuid())
  credentialId String
  type         InvitationType
  recipient    String // Email, telefone ou identificador
  token        String         @unique @default(uuid())

  // Mensagem
  subject    String?
  message    String?
  templateId String? // ID do template usado

  // Rastreamento
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?

  // Controle
  expiresAt   DateTime
  isActive    Boolean   @default(true)
  respondedAt DateTime?
  response    String? // ACCEPTED, REJECTED, etc

  // Tentativas
  attemptCount  Int       @default(0)
  lastAttemptAt DateTime?
  errorMessage  String?

  // Provider (SendGrid, Twilio, etc)
  providerMessageId String?
  providerResponse  Json?

  createdAt DateTime @default(now())

  credential SupplierCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@index([credentialId])
  @@index([token])
  @@map("credential_invitations")
}

// Onboarding da facção (após aceitar convite)
model SupplierOnboarding {
  id         String  @id @default(uuid())
  supplierId String  @unique // Vinculado diretamente ao supplier (Company)
  userId     String? // Usuário criado para a facção

  // Progresso geral
  currentStep    Int     @default(1)
  totalSteps     Int     @default(6)
  completedSteps Json? // Array de steps completados
  isCompleted    Boolean @default(false)

  // Steps individuais com timestamps
  emailVerifiedAt         DateTime?
  passwordCreatedAt       DateTime?
  companyDataCompletedAt  DateTime?
  documentsUploadedAt     DateTime?
  capabilitiesCompletedAt DateTime?

  // Controle
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  abandonedAt    DateTime?
  lastActivityAt DateTime  @default(now())

  // Analytics
  timeSpentSeconds Int   @default(0)
  deviceInfo       Json? // { browser, os, device, ip }

  supplier            Company              @relation("SupplierOnboarding", fields: [supplierId], references: [id], onDelete: Cascade)
  user                User?                @relation(fields: [userId], references: [id])
  documents           OnboardingDocument[]
  supplierCredentials SupplierCredential[]

  @@map("supplier_onboardings")
}

// Documentos enviados durante onboarding
model OnboardingDocument {
  id           String @id @default(uuid())
  onboardingId String
  type         String // Tipo do documento (alvara, certificacao, etc)
  name         String // Nome exibido
  fileName     String // Nome do arquivo
  fileUrl      String
  fileSize     Int // bytes
  mimeType     String

  // Validação
  isValid         Boolean?
  validationNotes String?
  validatedById   String?
  validatedAt     DateTime?

  createdAt DateTime @default(now())

  onboarding  SupplierOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)
  validatedBy User?              @relation("DocumentValidatedBy", fields: [validatedById], references: [id])

  @@map("onboarding_documents")
}

// Contrato entre marca e facção
model SupplierContract {
  id             String  @id @default(uuid())
  displayId      String  @unique // CTR-YYYYMMDD-XXXX
  relationshipId String? // Vinculado ao relacionamento marca-facção
  credentialId   String? @unique // Mantido para compatibilidade/migração

  // Desnormalizado para facilitar queries
  supplierId String?
  brandId    String?

  // Tipo e hierarquia de contratos
  type             ContractType @default(SERVICE_AGREEMENT)
  parentContractId String? // Para aditivos - referência ao contrato pai
  parentContract   SupplierContract?  @relation("ContractAmendments", fields: [parentContractId], references: [id])
  amendments       SupplierContract[] @relation("ContractAmendments")

  // Informações do contrato
  title       String?
  description String? @db.Text
  value       Decimal? @db.Decimal(12, 2)

  templateId      String?
  templateVersion String?
  documentUrl     String? // URL do documento gerado
  documentHash    String? // Hash para verificação de integridade
  terms           Json? // Termos específicos do contrato

  // Assinatura da marca
  brandSignedAt      DateTime?
  brandSignedById    String?
  brandSignatureIp   String?
  brandSignerName    String? // Nome do assinante da marca

  // Assinatura da facção
  supplierSignedAt      DateTime?
  supplierSignedById    String?
  supplierSignatureIp   String?
  supplierSignerName    String? // Nome do assinante da facção

  // Integração com plataforma de assinatura externa
  externalSignatureId  String? // ID no DocuSign, Clicksign, etc
  externalSignatureUrl String?
  externalStatus       String?

  // Status e vigência
  status          ContractStatus @default(DRAFT)
  validFrom       DateTime?
  validUntil      DateTime?
  renewalReminder Int?           @default(30) // Dias antes do vencimento para lembrete

  // Controle
  createdById String?
  createdBy   User?    @relation("ContractsCreated", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  relationship     SupplierBrandRelationship? @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  credential       SupplierCredential?        @relation(fields: [credentialId], references: [id], onDelete: Cascade)
  supplier         Company?                   @relation("SupplierContracts", fields: [supplierId], references: [id])
  brand            Company?                   @relation("BrandContracts", fields: [brandId], references: [id])
  brandSignedBy    User?                      @relation("ContractBrandSignedBy", fields: [brandSignedById], references: [id])
  supplierSignedBy User?                      @relation("ContractSupplierSignedBy", fields: [supplierSignedById], references: [id])
  revisions        ContractRevision[]

  @@index([relationshipId])
  @@index([brandId])
  @@index([supplierId])
  @@index([status])
  @@index([validUntil])
  @@map("supplier_contracts")
}

// Solicitações de revisão de contrato
model ContractRevision {
  id          String @id @default(uuid())
  contractId  String

  // Quem solicitou a revisão
  requestedById String
  requestedBy   User   @relation("RevisionsRequested", fields: [requestedById], references: [id])
  message       String @db.Text

  // Status da revisão
  status ContractRevisionStatus @default(PENDING)

  // Resposta à revisão
  respondedById  String?
  respondedBy    User?     @relation("RevisionsResponded", fields: [respondedById], references: [id])
  respondedAt    DateTime?
  responseNotes  String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contract SupplierContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([status])
  @@map("contract_revisions")
}

// Relacionamento N:M entre Fornecedor e Marca
// Uma facção pode trabalhar para múltiplas marcas simultaneamente
model SupplierBrandRelationship {
  id         String @id @default(uuid())
  supplierId String
  brandId    String

  // Status do relacionamento com ESTA marca
  status RelationshipStatus @default(PENDING)

  // Quem iniciou/gerencia
  initiatedBy     String // User ID (admin ou marca)
  initiatedByRole UserRole

  // Controle interno da marca para ESTE fornecedor
  internalCode String? // Código interno da marca
  notes        String? @db.Text // Observações internas
  priority     Int     @default(0) // Ordem de prioridade

  // Datas
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  activatedAt  DateTime?
  suspendedAt  DateTime?
  terminatedAt DateTime?

  // LGPD Document Sharing Consent
  documentSharingConsent       Boolean   @default(false)
  documentSharingConsentAt     DateTime?
  documentSharingConsentIp     String?
  documentSharingRevokedAt     DateTime?
  documentSharingRevokedReason String?   @db.Text

  // Relations
  supplier Company @relation("SupplierRelationships", fields: [supplierId], references: [id], onDelete: Cascade)
  brand    Company @relation("BrandSuppliers", fields: [brandId], references: [id], onDelete: Cascade)

  initiatedByUser User @relation("RelationshipsInitiated", fields: [initiatedBy], references: [id])

  contracts           SupplierContract[]
  specificDocuments   BrandSpecificDocument[]
  statusHistory       RelationshipStatusHistory[]
  orders              Order[]                     @relation("RelationshipOrders")
  partnershipRequest  PartnershipRequest?
  documentAcceptances BrandDocumentAcceptance[]

  @@unique([supplierId, brandId])
  @@index([supplierId])
  @@index([brandId])
  @@index([status])
  @@map("supplier_brand_relationships")
}

// Histórico de mudanças de status do relacionamento
model RelationshipStatusHistory {
  id             String             @id @default(uuid())
  relationshipId String
  status         RelationshipStatus
  notes          String?            @db.Text
  changedById    String
  createdAt      DateTime           @default(now())

  relationship SupplierBrandRelationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  changedBy    User                      @relation("RelationshipStatusChanged", fields: [changedById], references: [id])

  @@index([relationshipId])
  @@map("relationship_status_history")
}

// Solicitação de parceria entre Marca e Facção
model PartnershipRequest {
  id            String @id @default(uuid())
  brandId       String
  supplierId    String
  requestedById String

  status  PartnershipRequestStatus @default(PENDING)
  message String?                  @db.Text

  respondedById   String?
  respondedAt     DateTime?
  rejectionReason String?   @db.Text

  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  relationshipId String? @unique

  // Relations
  brand        Company                    @relation("BrandPartnershipRequests", fields: [brandId], references: [id])
  supplier     Company                    @relation("SupplierPartnershipRequests", fields: [supplierId], references: [id])
  requestedBy  User                       @relation("PartnershipRequestsSent", fields: [requestedById], references: [id])
  respondedBy  User?                      @relation("PartnershipRequestsResponded", fields: [respondedById], references: [id])
  relationship SupplierBrandRelationship? @relation(fields: [relationshipId], references: [id])

  @@unique([brandId, supplierId, status])
  @@index([brandId])
  @@index([supplierId])
  @@index([status])
  @@map("partnership_requests")
}

// Documentos específicos exigidos por uma marca para um fornecedor
model BrandSpecificDocument {
  id             String  @id @default(uuid())
  relationshipId String
  type           String // Tipo de documento específico
  name           String
  description    String? @db.Text
  isRequired     Boolean @default(false)

  // Arquivo
  fileName String
  fileUrl  String
  fileSize Int
  mimeType String

  // Validação pela marca
  isValid         Boolean?
  validationNotes String?   @db.Text
  validatedAt     DateTime?
  validatedById   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  relationship SupplierBrandRelationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  validatedBy  User?                     @relation("BrandDocsValidated", fields: [validatedById], references: [id])

  @@index([relationshipId])
  @@map("brand_specific_documents")
}

// Templates de convite por empresa
model InvitationTemplate {
  id        String         @id @default(uuid())
  companyId String? // Null = template global
  name      String
  type      InvitationType
  subject   String? // Para emails
  content   String         @db.Text
  isActive  Boolean        @default(true)
  isDefault Boolean        @default(false)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("invitation_templates")
}

// Templates de contrato por empresa
model ContractTemplate {
  id        String   @id @default(uuid())
  companyId String? // Null = template global
  name      String
  version   String   @default("1.0")
  content   String   @db.Text
  variables Json? // Variáveis que podem ser substituídas
  isActive  Boolean  @default(true)
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("contract_templates")
}

// Configurações de credenciamento por marca
model CredentialSettings {
  id        String @id @default(uuid())
  companyId String @unique

  // Validações automáticas
  autoValidateCNPJ    Boolean @default(true)
  autoCheckCredit     Boolean @default(true)
  autoCheckCompliance Boolean @default(true)

  // Thresholds de aprovação
  minCreditScore Int? // Score mínimo para aprovação automática
  maxRiskLevel   RiskLevel @default(MEDIUM) // Risco máximo aceito

  // Configurações de convite
  defaultInvitationType InvitationType @default(EMAIL)
  invitationExpiryDays  Int            @default(7)
  maxInvitationAttempts Int            @default(3)

  // Onboarding
  requiredDocuments String[] // Tipos de documentos obrigatórios
  requireContract   Boolean  @default(true)

  // Configurações de pedido
  defaultProtectTechnicalSheet Boolean @default(false)

  // Notificações
  notifyOnNewCredential Boolean  @default(true)
  notifyOnStatusChange  Boolean  @default(true)
  notificationEmails    String[] // Emails para notificar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("credential_settings")
}

// ==================== SUPPLIER DOCUMENTS ====================

// Tipos de documentos de fornecedor (compliance/fiscal)
enum SupplierDocumentType {
  ABVTEX_TERMO // Termo de Participação do Programa ABVTEX
  CNPJ_ATIVO // Cartão CNPJ válido (situação ativa)
  CND_FEDERAL // Certidão Negativa de Débitos Federais
  CRF_FGTS // Certificado de Regularidade do FGTS
  GUIA_INSS // Guia e comprovante de pagamento do INSS
  GUIA_FGTS // Guia e comprovante de pagamento de FGTS
  GUIA_SIMPLES_DAS // Guia e comprovante de pagamento do Simples Nacional (DAS)
  LICENCA_FUNCIONAMENTO // Licença de Funcionamento
  AVCB // Auto de Vistoria do Corpo de Bombeiros
  CONTRATO_SOCIAL // Contrato Social / Requerimento do Empresário
  INSCRICAO_MUNICIPAL // Inscrição Municipal
  RELATORIO_EMPREGADOS // Relatório de empregados (CAGED / eSocial / RAIS)
  RELACAO_SUBCONTRATADOS // Relação de subcontratados
  LICENCA_AMBIENTAL // Licença ambiental
  LAUDO_NR1_GRO_PGR // Laudo NR-1 – GRO / PGR
  LAUDO_NR7_PCMSO // Laudo NR-7 – PCMSO
  LAUDO_NR10_SEGURANCA_ELETRICA // Laudo NR-10 – Laudo e treinamentos de segurança elétrica
  LAUDO_NR15_INSALUBRIDADE // Laudo NR-15 – Laudo de Insalubridade
  LAUDO_NR17_AET // Laudo NR-17 – AET – Análise Ergonômica do Trabalho
  OUTRO // Outro documento
}

// Status de documento de fornecedor
enum SupplierDocumentStatus {
  PENDING // Documento pendente de upload
  VALID // Documento válido (dentro da validade)
  EXPIRING_SOON // Documento próximo do vencimento (30 dias)
  EXPIRED // Documento vencido
}

// Documento de fornecedor (compliance/fiscal)
model SupplierDocument {
  id        String                 @id @default(uuid())
  companyId String
  type      SupplierDocumentType
  status    SupplierDocumentStatus @default(PENDING)

  // Arquivo
  fileName String?
  fileUrl  String?
  fileKey  String? // S3 object key for presigned URL generation
  fileSize Int? // bytes
  mimeType String?

  // Datas
  uploadedAt      DateTime? // Data de upload/lançamento
  competenceMonth Int? // Mês de competência (1-12)
  competenceYear  Int? // Ano de competência
  expiresAt       DateTime? // Data de validade

  // Observações
  notes String? @db.Text

  // Controle
  uploadedById String? // Usuário que fez upload
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  company    Company @relation("SupplierDocuments", fields: [companyId], references: [id], onDelete: Cascade)
  uploadedBy User?   @relation("DocumentsUploaded", fields: [uploadedById], references: [id])

  @@index([companyId])
  @@index([type])
  @@index([status])
  @@index([expiresAt])
  @@map("supplier_documents")
}

// ==================== EDUCATIONAL CONTENT (Texlink Educa) ====================

enum EducationalContentType {
  VIDEO
  IMAGE
  DOCUMENT
  ARTICLE
}

enum EducationalContentCategory {
  TUTORIAL_SISTEMA // Tutorial do Sistema
  BOAS_PRATICAS // Boas Práticas
  COMPLIANCE // Compliance
  PRODUCAO // Produção
  FINANCEIRO // Financeiro
  QUALIDADE // Qualidade
  NOVIDADES // Novidades
}

model EducationalContent {
  id           String                     @id @default(uuid())
  title        String
  description  String                     @db.Text
  contentType  EducationalContentType
  contentUrl   String // URL do vídeo/documento/imagem
  thumbnailUrl String? // Thumbnail para cards
  category     EducationalContentCategory
  duration     String? // Para vídeos: "5:30"
  isActive     Boolean                    @default(true)
  displayOrder Int                        @default(0)
  createdAt    DateTime                   @default(now())
  updatedAt    DateTime                   @updatedAt

  @@index([isActive])
  @@index([category])
  @@index([contentType])
  @@map("educational_contents")
}

// ==================== PARTNERS (Benefícios/Parcerias) ====================

enum PartnerCategory {
  HEALTH_WELLNESS // Saúde e Bem-estar
  COMPLIANCE // Compliance e NR
  ACCOUNTING // Contabilidade
  FINANCE // Financeiro/Crédito
  TECHNOLOGY // Tecnologia
  TRAINING // Treinamentos
  INSURANCE // Seguros
  OTHER // Outros
}

model Partner {
  id           String          @id @default(uuid())
  name         String
  description  String          @db.Text
  logoUrl      String?
  website      String
  category     PartnerCategory
  benefits     String[] // Lista de benefícios oferecidos
  contactEmail String?
  contactPhone String?
  discountCode String? // Código de desconto exclusivo
  discountInfo String? // Descrição do desconto/benefício
  isActive     Boolean         @default(true)
  displayOrder Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([isActive])
  @@index([category])
  @@index([displayOrder])
  @@map("partners")
}

// ==================== SUPPORT TICKETS ====================

model SupportTicket {
  id           String  @id @default(uuid())
  displayId    String  @unique // SUP-YYYYMMDD-XXXX
  companyId    String
  createdById  String
  assignedToId String? // Admin responsável

  title       String
  description String                @db.Text
  category    SupportTicketCategory
  status      SupportTicketStatus   @default(ABERTO)
  priority    SupportTicketPriority @default(MEDIA)

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?
  closedAt   DateTime?

  // Relations
  company       Company                      @relation("CompanyTickets", fields: [companyId], references: [id], onDelete: Cascade)
  createdBy     User                         @relation("TicketsCreated", fields: [createdById], references: [id])
  assignedTo    User?                        @relation("TicketsAssigned", fields: [assignedToId], references: [id])
  messages      SupportTicketMessage[]
  statusHistory SupportTicketStatusHistory[]

  @@index([companyId])
  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdAt])
  @@map("support_tickets")
}

model SupportTicketMessage {
  id            String   @id @default(uuid())
  ticketId      String
  senderId      String
  content       String   @db.Text
  attachments   String[] // URLs dos anexos
  isFromSupport Boolean  @default(false)
  isInternal    Boolean  @default(false) // Nota interna (só admin vê)
  createdAt     DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender User          @relation("TicketMessagesSent", fields: [senderId], references: [id])

  @@index([ticketId, createdAt])
  @@map("support_ticket_messages")
}

model SupportTicketStatusHistory {
  id          String               @id @default(uuid())
  ticketId    String
  fromStatus  SupportTicketStatus?
  toStatus    SupportTicketStatus
  changedById String
  notes       String?
  createdAt   DateTime             @default(now())

  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  changedBy User          @relation("TicketStatusChanges", fields: [changedById], references: [id])

  @@index([ticketId])
  @@map("support_ticket_status_history")
}

// ==================== SETTINGS MODELS ====================

model BankAccount {
  id             String      @id @default(uuid())
  companyId      String      @unique
  bankCode       String
  bankName       String
  agency         String
  accountNumber  String
  accountType    AccountType @default(CORRENTE)
  accountHolder  String
  holderDocument String
  pixKeyType     PixKeyType?
  pixKey         String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("bank_accounts")
}

model NotificationSettings {
  id                String   @id @default(uuid())
  companyId         String   @unique
  emailEnabled      Boolean  @default(true)
  whatsappEnabled   Boolean  @default(false)
  newOrdersEmail    Boolean  @default(true)
  newOrdersWhatsapp Boolean  @default(true)
  messagesEmail     Boolean  @default(true)
  messagesWhatsapp  Boolean  @default(false)
  paymentsEmail     Boolean  @default(true)
  paymentsWhatsapp  Boolean  @default(true)
  deadlineReminders Boolean  @default(true)
  systemUpdates     Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}

model Suggestion {
  id          String             @id @default(uuid())
  companyId   String
  userId      String
  category    SuggestionCategory
  title       String
  description String             @db.Text
  status      SuggestionStatus   @default(ENVIADO)
  adminNotes  String?            @db.Text
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@map("suggestions")
}

// ==================== NOTIFICATION SYSTEM ====================

model Notification {
  id       String               @id @default(uuid())
  type     NotificationType
  priority NotificationPriority @default(NORMAL)

  recipientId String
  companyId   String?

  title     String
  body      String
  data      Json?
  actionUrl String?

  entityType String?
  entityId   String?

  websocketStatus NotificationDeliveryStatus @default(PENDING)
  websocketSentAt DateTime?
  emailStatus     NotificationDeliveryStatus @default(PENDING)
  emailSentAt     DateTime?
  whatsappStatus  NotificationDeliveryStatus @default(PENDING)
  whatsappSentAt  DateTime?

  read   Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipient User @relation("NotificationsReceived", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId, read, createdAt(sort: Desc)])
  @@index([type, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@map("notifications")
}

// ==================== BRAND DOCUMENTS (Code of Conduct, etc.) ====================

model BrandDocument {
  id      String              @id @default(uuid())
  brandId String
  type    BrandDocumentType
  status  BrandDocumentStatus @default(DRAFT)

  title       String
  description String? @db.Text
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String

  version       String @default("1.0")
  versionNumber Int    @default(1)

  isRequired           Boolean @default(false)
  requiresReacceptance Boolean @default(true)

  uploadedById String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  archivedAt   DateTime?

  brand       Company                   @relation("BrandDocuments", fields: [brandId], references: [id], onDelete: Cascade)
  uploadedBy  User                      @relation("BrandDocumentsUploaded", fields: [uploadedById], references: [id])
  acceptances BrandDocumentAcceptance[]
  versions    BrandDocumentVersion[]

  @@unique([brandId, type, status])
  @@index([brandId])
  @@index([type])
  @@map("brand_documents")
}

model BrandDocumentVersion {
  id            String   @id @default(uuid())
  documentId    String
  version       String
  versionNumber Int
  fileName      String
  fileUrl       String
  fileSize      Int
  uploadedById  String
  createdAt     DateTime @default(now())
  notes         String?  @db.Text

  document BrandDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("brand_document_versions")
}

model BrandDocumentAcceptance {
  id             String @id @default(uuid())
  documentId     String
  relationshipId String

  acceptedAt            DateTime @default(now())
  acceptedVersion       String
  acceptedVersionNumber Int

  acceptedById   String
  acceptedByName String
  acceptedByRole String?
  clientIp       String
  userAgent      String? @db.Text

  checkboxConfirmed Boolean @default(true)

  document     BrandDocument             @relation(fields: [documentId], references: [id], onDelete: Cascade)
  relationship SupplierBrandRelationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  acceptedBy   User                      @relation("AcceptedBrandDocuments", fields: [acceptedById], references: [id])

  @@unique([documentId, relationshipId])
  @@index([documentId])
  @@index([relationshipId])
  @@map("brand_document_acceptances")
}

// Admin audit trail for company status changes
model AdminAction {
  id        String @id @default(uuid())
  companyId String
  adminId   String
  action    String // APPROVED, REJECTED, SUSPENDED, etc.
  reason    String? @db.Text
  previousStatus String?
  newStatus      String?
  createdAt DateTime @default(now())

  company Company @relation("CompanyAdminActions", fields: [companyId], references: [id], onDelete: Cascade)
  admin   User    @relation("AdminActionsPerformed", fields: [adminId], references: [id])

  @@index([companyId])
  @@index([adminId])
  @@index([createdAt])
  @@map("admin_actions")
}
