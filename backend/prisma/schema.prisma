// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN
  BRAND
  SUPPLIER
}

enum CompanyType {
  BRAND
  SUPPLIER
}

enum CompanyStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum CompanyUserRole {
  OWNER
  MANAGER
  MEMBER
}

// Roles pré-definidos para membros da empresa
enum CompanyRole {
  ADMIN               // Todas as permissões + gestão de equipe
  OPERATIONS_MANAGER  // Pedidos, fornecedores, mensagens, relatórios
  FINANCIAL_MANAGER   // Financeiro, relatórios
  SALES               // Criar pedidos, ver fornecedores, mensagens
  PRODUCTION_MANAGER  // (Facção) Pedidos, capacidade, mensagens
  VIEWER              // Apenas visualização
}

// Permissões granulares
enum Permission {
  // Pedidos
  ORDERS_VIEW
  ORDERS_CREATE
  ORDERS_EDIT
  ORDERS_DELETE
  ORDERS_ACCEPT_REJECT      // Aceitar/rejeitar (facção)
  ORDERS_UPDATE_STATUS

  // Fornecedores/Parceiros
  SUPPLIERS_VIEW
  SUPPLIERS_ADD
  SUPPLIERS_REMOVE
  SUPPLIERS_RATE

  // Financeiro
  FINANCIAL_VIEW
  FINANCIAL_MANAGE
  FINANCIAL_EXPORT

  // Mensagens
  MESSAGES_VIEW
  MESSAGES_SEND

  // Relatórios
  REPORTS_VIEW
  REPORTS_EXPORT

  // Gestão de Equipe
  TEAM_VIEW
  TEAM_INVITE
  TEAM_MANAGE
  TEAM_MANAGE_PERMISSIONS

  // Configurações
  SETTINGS_VIEW
  SETTINGS_EDIT

  // Capacidade (Facção)
  CAPACITY_VIEW
  CAPACITY_MANAGE
}

// Status de convite
enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum DocumentType {
  ALVARA
  CERTIFICACAO
  FOTO_OPERACAO
  FOTO_PRODUTO
  OUTRO
}

enum OrderStatus {
  LANCADO_PELA_MARCA
  ACEITO_PELA_FACCAO
  EM_PREPARACAO_SAIDA_MARCA
  EM_TRANSITO_PARA_FACCAO
  EM_PREPARACAO_ENTRADA_FACCAO
  EM_PRODUCAO
  PRONTO
  EM_TRANSITO_PARA_MARCA
  EM_REVISAO                    // Em revisão de qualidade
  PARCIALMENTE_APROVADO         // Parte aprovada, parte com problemas
  REPROVADO                     // Totalmente reprovado
  AGUARDANDO_RETRABALHO         // Aguardando pedido filho ser aceito
  FINALIZADO
  RECUSADO_PELA_FACCAO
  DISPONIVEL_PARA_OUTRAS
}

// Origem do pedido (original ou retrabalho)
enum OrderOrigin {
  ORIGINAL        // Pedido original
  REWORK          // Retrabalho de pedido reprovado
}

// Tipo de revisão
enum ReviewType {
  QUALITY_CHECK   // Verificação de qualidade durante produção
  FINAL_REVIEW    // Revisão final antes de finalizar
}

// Resultado da revisão
enum ReviewResult {
  APPROVED        // 100% aprovado
  PARTIAL         // Parcialmente aprovado
  REJECTED        // 100% reprovado
}

enum OrderAssignmentType {
  DIRECT
  BIDDING
  HYBRID
}

enum OrderTargetStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum AttachmentType {
  TECH_SHEET
  VIDEO
  IMAGE
  DOC
  OTHER
}

enum PaymentStatus {
  PENDENTE
  PARCIAL
  PAGO
  ATRASADO
}

enum MessageType {
  TEXT
  PROPOSAL
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// ==================== MODELS ====================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  role         UserRole
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  companyUsers         CompanyUser[]
  orderStatusChanges   OrderStatusHistory[]
  messages             Message[]
  ordersAccepted       Order[]              @relation("AcceptedBy")
  invitationsSent      Invitation[]         @relation("InvitationsSent")
  reviewsPerformed     OrderReview[]        @relation("ReviewedBy")

  @@map("users")
}

model Company {
  id         String        @id @default(uuid())
  legalName  String
  tradeName  String?
  document   String        @unique // CNPJ or CPF
  type       CompanyType
  city       String
  state      String
  phone      String?
  email      String?
  logoUrl    String?
  avgRating  Decimal       @default(0) @db.Decimal(2, 1)
  status     CompanyStatus @default(PENDING)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  companyUsers     CompanyUser[]
  supplierProfile  SupplierProfile?
  documents        Document[]
  ordersAsBrand    Order[]              @relation("BrandOrders")
  ordersAsSupplier Order[]              @relation("SupplierOrders")
  targetedOrders   OrderTargetSupplier[]
  ratingsGiven     Rating[]             @relation("RatingsGiven")
  ratingsReceived  Rating[]             @relation("RatingsReceived")
  invitations      Invitation[]

  // Favorites & Templates (for BRAND)
  productTemplates    ProductTemplate[]
  favoriteSuppliers   FavoriteSupplier[] @relation("BrandFavorites")
  favoritedBy         FavoriteSupplier[] @relation("FavoritedBy")
  paymentTermsPresets PaymentTermsPreset[]

  @@map("companies")
}

model CompanyUser {
  id             String          @id @default(uuid())
  userId         String
  companyId      String
  role           CompanyUserRole @default(MEMBER)    // Mantido para compatibilidade
  companyRole    CompanyRole     @default(VIEWER)    // Role pré-definido
  isCompanyAdmin Boolean         @default(false)     // Flag de admin
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  user        User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  permissions CompanyUserPermission[]   // Overrides individuais

  @@unique([userId, companyId])
  @@map("company_users")
}

// Override de permissão individual por usuário
model CompanyUserPermission {
  id            String     @id @default(uuid())
  companyUserId String
  permission    Permission
  granted       Boolean    @default(true)  // true = conceder, false = negar
  createdAt     DateTime   @default(now())

  companyUser CompanyUser @relation(fields: [companyUserId], references: [id], onDelete: Cascade)

  @@unique([companyUserId, permission])
  @@map("company_user_permissions")
}

// Sistema de convites
model Invitation {
  id          String           @id @default(uuid())
  companyId   String
  email       String
  companyRole CompanyRole      @default(VIEWER)
  invitedById String
  token       String           @unique @default(uuid())
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  createdAt   DateTime         @default(now())

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invitedBy User    @relation("InvitationsSent", fields: [invitedById], references: [id])

  @@unique([companyId, email, status])  // Um convite pendente por email/empresa
  @@map("invitations")
}

model SupplierProfile {
  id                    String   @id @default(uuid())
  companyId             String   @unique
  onboardingPhase       Int      @default(1) // 1, 2, or 3
  onboardingComplete    Boolean  @default(false)
  
  // Phase 2: Business Qualification
  businessQualification Json?    // { interesse, faturamentoDesejado, maturidadeGestao, qtdColaboradores }
  
  // Phase 3: Production Capacity
  productionCapacity    Json?    // { tiposProduto, subcategorias, especialidades }
  productTypes          String[] // e.g., ["Infantil", "Adulto", "Fitness"]
  specialties           String[] // e.g., ["Jeans", "Malha", "Tricô"]
  
  monthlyCapacity       Int?     // peças/mês
  currentOccupancy      Int      @default(0) // % ocupação atual
  desiredRevenue        Decimal? @db.Decimal(12, 2)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("supplier_profiles")
}

model Document {
  id        String       @id @default(uuid())
  companyId String
  type      DocumentType
  name      String
  url       String
  mimeType  String
  size      Int          // bytes
  createdAt DateTime     @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Order {
  id                String              @id @default(uuid())
  displayId         String              @unique // TX-YYYYMMDD-XXXX ou TX-YYYYMMDD-XXXX-R1
  brandId           String
  supplierId        String?             // null until accepted in BIDDING mode
  
  status            OrderStatus         @default(LANCADO_PELA_MARCA)
  assignmentType    OrderAssignmentType @default(DIRECT)
  
  // Hierarquia de pedidos (pai/filho para retrabalho)
  parentOrderId     String?
  parentOrder       Order?              @relation("OrderHierarchy", fields: [parentOrderId], references: [id])
  childOrders       Order[]             @relation("OrderHierarchy")
  revisionNumber    Int                 @default(0)  // 0 = original, 1+ = retrabalho
  origin            OrderOrigin         @default(ORIGINAL)
  
  // Product info
  productType       String              // e.g., "Infantil"
  productCategory   String?             // e.g., "Camiseta"
  productName       String
  description       String?
  
  quantity          Int
  pricePerUnit      Decimal             @db.Decimal(10, 2)
  totalValue        Decimal             @db.Decimal(12, 2)
  
  deliveryDeadline  DateTime
  paymentTerms      String?             // e.g., "50% adiantado, 50% na entrega"
  materialsProvided Boolean             @default(false)
  
  techSheetUrl      String?
  observations      String?
  rejectionReason   String?
  
  acceptedAt        DateTime?
  acceptedById      String?
  
  // Métricas de revisão agregadas
  totalReviewCount    Int               @default(0)
  approvalCount       Int               @default(0)
  rejectionCount      Int               @default(0)
  secondQualityCount  Int               @default(0)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  brand             Company             @relation("BrandOrders", fields: [brandId], references: [id])
  supplier          Company?            @relation("SupplierOrders", fields: [supplierId], references: [id])
  acceptedBy        User?               @relation("AcceptedBy", fields: [acceptedById], references: [id])
  
  statusHistory     OrderStatusHistory[]
  attachments       OrderAttachment[]
  targetSuppliers   OrderTargetSupplier[]
  messages          Message[]
  payments          Payment[]
  ratings           Rating[]
  reviews           OrderReview[]
  secondQualityItems SecondQualityItem[]

  @@map("orders")
}

model OrderTargetSupplier {
  id          String            @id @default(uuid())
  orderId     String
  supplierId  String
  status      OrderTargetStatus @default(PENDING)
  respondedAt DateTime?
  createdAt   DateTime          @default(now())

  order    Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  supplier Company @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([orderId, supplierId])
  @@map("order_target_suppliers")
}

model OrderStatusHistory {
  id             String      @id @default(uuid())
  orderId        String
  previousStatus OrderStatus?
  newStatus      OrderStatus
  changedById    String?
  notes          String?
  createdAt      DateTime    @default(now())

  order     Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  changedBy User? @relation(fields: [changedById], references: [id])

  @@map("order_status_history")
}

model OrderAttachment {
  id            String         @id @default(uuid())
  orderId       String
  type          AttachmentType
  name          String
  url           String
  mimeType      String
  size          Int            // bytes
  downloadCount Int            @default(0)
  createdAt     DateTime       @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_attachments")
}

model Payment {
  id        String        @id @default(uuid())
  orderId   String
  amount    Decimal       @db.Decimal(12, 2)
  dueDate   DateTime
  paidDate  DateTime?
  status    PaymentStatus @default(PENDENTE)
  method    String?       // e.g., "PIX", "Boleto", "Transferência"
  proofUrl  String?
  notes     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Rating {
  id            String   @id @default(uuid())
  orderId       String
  fromCompanyId String
  toCompanyId   String
  score         Int      // 1 to 5
  comment       String?
  createdAt     DateTime @default(now())

  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fromCompany Company @relation("RatingsGiven", fields: [fromCompanyId], references: [id])
  toCompany   Company @relation("RatingsReceived", fields: [toCompanyId], references: [id])

  @@unique([orderId, fromCompanyId]) // Each company can rate once per order
  @@map("ratings")
}

model Message {
  id           String       @id @default(uuid())
  orderId      String
  senderId     String
  type         MessageType  @default(TEXT)
  content      String?

  // For proposals
  proposalData Json?        // { originalValues, newValues, status }

  read         Boolean      @default(false)
  createdAt    DateTime     @default(now())

  order  Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sender User  @relation(fields: [senderId], references: [id])

  @@map("messages")
}

// ==================== FAVORITES & TEMPLATES ====================

// Product template for reuse when creating orders
model ProductTemplate {
  id                String   @id @default(uuid())
  companyId         String
  name              String   // Template name (e.g., "Camiseta Básica Padrão")
  productType       String
  productCategory   String?
  productName       String
  description       String?
  materialsProvided Boolean  @default(false)
  defaultPrice      Decimal? @db.Decimal(10, 2)
  observations      String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("product_templates")
}

// Favorite supplier for brands
model FavoriteSupplier {
  id         String   @id @default(uuid())
  companyId  String   // Brand
  supplierId String   // Supplier (Facção)
  notes      String?  // Personal notes
  priority   Int      @default(0) // Preference order
  createdAt  DateTime @default(now())

  company  Company @relation("BrandFavorites", fields: [companyId], references: [id], onDelete: Cascade)
  supplier Company @relation("FavoritedBy", fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([companyId, supplierId])
  @@map("favorite_suppliers")
}

// Payment terms presets
model PaymentTermsPreset {
  id          String   @id @default(uuid())
  companyId   String
  name        String   // Preset name (e.g., "Parcelado 30/60/90")
  terms       String   // Payment terms text
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("payment_terms_presets")
}

// ==================== ORDER REVIEW SYSTEM ====================

// Revisão de qualidade do pedido
model OrderReview {
  id                    String       @id @default(uuid())
  orderId               String
  type                  ReviewType
  result                ReviewResult
  totalQuantity         Int          // Quantidade total revisada
  approvedQuantity      Int          @default(0)
  rejectedQuantity      Int          @default(0)
  secondQualityQuantity Int          @default(0)
  notes                 String?
  reviewedAt            DateTime     @default(now())
  reviewedById          String
  
  // Se gerou pedido filho de retrabalho
  childOrderId          String?      // ID do pedido filho gerado (se houver)
  
  order                 Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  reviewedBy            User         @relation("ReviewedBy", fields: [reviewedById], references: [id])
  rejectedItems         ReviewRejectedItem[]
  createdAt             DateTime     @default(now())

  @@map("order_reviews")
}

// Itens reprovados em uma revisão (detalhes)
model ReviewRejectedItem {
  id                String       @id @default(uuid())
  reviewId          String
  reason            String       // Motivo da reprovação
  quantity          Int
  defectDescription String?      // Descrição detalhada do defeito
  requiresRework    Boolean      @default(true) // Se precisa de retrabalho
  
  review            OrderReview  @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  
  @@map("review_rejected_items")
}

// Itens de segunda qualidade gerados por revisões
model SecondQualityItem {
  id                  String   @id @default(uuid())
  orderId             String
  reviewId            String?  // Referência à revisão que gerou (opcional)
  quantity            Int
  defectType          String   // Tipo do defeito (ex: "Costura", "Manchado")
  defectDescription   String?
  originalUnitValue   Decimal  @db.Decimal(10, 2) // Valor original da peça
  discountPercentage  Decimal  @default(0) @db.Decimal(5, 2) // % de desconto aplicado
  finalUnitValue      Decimal? @db.Decimal(10, 2) // Valor final com desconto
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("second_quality_items")
}
